# نظام نقاط الولاء

## نظرة عامة

نظام نقاط الولاء هو برنامج مكافآت يهدف إلى تشجيع العملاء على تكرار الشراء وبناء علاقة طويلة الأمد مع المتجر. يكسب العملاء نقاطاً عند إتمام عمليات الشراء، ويمكنهم استبدال هذه النقاط للحصول على خصومات على الطلبات المستقبلية.

---

## الإعدادات العامة

| الإعداد | القيمة الافتراضية | الوصف |
|---------|------------------|-------|
| `loyalty_enabled` | `true` | تفعيل/تعطيل برنامج الولاء |
| `points_per_sar` | `1` | عدد النقاط المكتسبة لكل ريال |
| `points_value_in_sar` | `0.01` | قيمة النقطة الواحدة بالريال |

### قيمة النقطة
- **100 نقطة = 1 ريال سعودي**
- يمكن تغيير هذه القيمة من إعدادات النظام

---

## كيفية حساب النقاط

### المعادلة
```
النقاط المكتسبة = (قيمة الطلب ÷ 10) × مضاعف المستوى
```

### أمثلة عملية

| قيمة الطلب | المستوى | المضاعف | النقاط المكتسبة |
|-----------|---------|---------|----------------|
| 100 ريال | برونزي | 1x | 10 نقاط |
| 100 ريال | فضي | 1.25x | 12 نقطة |
| 100 ريال | ذهبي | 1.5x | 15 نقطة |
| 100 ريال | بلاتيني | 2x | 20 نقطة |
| 500 ريال | بلاتيني | 2x | 100 نقطة |

### وقت إضافة النقاط
- تُضاف النقاط تلقائياً عند **اكتمال الطلب** (تحول حالة الطلب إلى `completed`)
- يتم التحقق من عدم تكرار إضافة النقاط لنفس الطلب (منع التكرار)

---

## مستويات الولاء (Tiers)

### المستوى البرونزي (Bronze)
| الخاصية | القيمة |
|---------|--------|
| الحد الأدنى | 0 نقطة |
| مضاعف النقاط | 1x |
| خصم إضافي | - |
| شحن مجاني | ❌ |
| دعم أولوية | ❌ |
| وصول مبكر | ❌ |

### المستوى الفضي (Silver)
| الخاصية | القيمة |
|---------|--------|
| الحد الأدنى | 1,000 نقطة |
| مضاعف النقاط | 1.25x |
| خصم إضافي | 2% |
| شحن مجاني | ❌ |
| دعم أولوية | ❌ |
| وصول مبكر | ❌ |

### المستوى الذهبي (Gold)
| الخاصية | القيمة |
|---------|--------|
| الحد الأدنى | 5,000 نقطة |
| مضاعف النقاط | 1.5x |
| خصم إضافي | 5% |
| شحن مجاني | ✅ |
| دعم أولوية | ❌ |
| وصول مبكر | ❌ |

### المستوى البلاتيني (Platinum)
| الخاصية | القيمة |
|---------|--------|
| الحد الأدنى | 15,000 نقطة |
| مضاعف النقاط | 2x |
| خصم إضافي | 10% |
| شحن مجاني | ✅ |
| دعم أولوية | ✅ |
| وصول مبكر للعروض | ✅ |

### مقارنة سريعة

| المستوى | النقاط المطلوبة | المضاعف | الخصم | الشحن المجاني |
|---------|----------------|---------|-------|--------------|
| برونزي | 0 | 1x | - | ❌ |
| فضي | 1,000 | 1.25x | 2% | ❌ |
| ذهبي | 5,000 | 1.5x | 5% | ✅ |
| بلاتيني | 15,000 | 2x | 10% | ✅ |

---

## طرق كسب النقاط

### 1. من الطلبات (`order_earn`)
- تُحسب بناءً على قيمة الطلب ومستوى العميل
- تُضاف عند اكتمال الطلب فقط

### 2. مكافأة التسجيل (`signup_bonus`)
- نقاط تُضاف تلقائياً عند إنشاء حساب جديد

### 3. مكافأة الإحالة (`referral_earn`)
- نقاط تُضاف عند إحالة صديق وإتمامه أول طلب

### 4. مكافأة عيد الميلاد (`birthday_bonus`)
- نقاط خاصة تُضاف في عيد ميلاد العميل

### 5. مكافأة ترقية المستوى (`tier_upgrade`)
- نقاط تُضاف عند الانتقال لمستوى أعلى

### 6. إضافة من الإدارة (`admin_grant`)
- نقاط يضيفها المشرف يدوياً للعميل

---

## طرق صرف النقاط

### 1. الاستخدام في الطلبات (`order_redeem`)
- يمكن للعميل استخدام نقاطه للحصول على خصم عند الدفع
- **100 نقطة = 1 ريال خصم**
- يجب أن يكون لدى العميل نقاط كافية

### 2. خصم من الإدارة (`admin_deduct`)
- خصم نقاط بواسطة المشرف

### 3. انتهاء الصلاحية (`points_expiry`)
- النقاط لها تاريخ انتهاء صلاحية
- تُخصم تلقائياً عند انتهاء صلاحيتها

---

## صلاحية النقاط

### نظام انتهاء الصلاحية
- لكل دفعة نقاط تاريخ انتهاء صلاحية (`expiresAt`)
- يتم تتبع النقاط المنتهية الصلاحية بشكل منفصل

### طريقة الصرف (FIFO)
- عند استخدام النقاط، تُصرف **النقاط الأقدم أولاً**
- هذا يضمن استخدام النقاط قبل انتهاء صلاحيتها

### الإشعارات
- يمكن إرسال تذكيرات للعملاء قبل انتهاء صلاحية نقاطهم

---

## أنواع معاملات النقاط

| النوع | الاتجاه | الوصف |
|-------|---------|-------|
| `order_earn` | كسب | نقاط من طلب مكتمل |
| `order_redeem` | صرف | استخدام نقاط في طلب |
| `order_cancel` | تعديل | إلغاء نقاط طلب ملغي |
| `signup_bonus` | كسب | مكافأة التسجيل |
| `referral_earn` | كسب | مكافأة الإحالة |
| `birthday_bonus` | كسب | مكافأة عيد الميلاد |
| `tier_upgrade` | كسب | مكافأة ترقية المستوى |
| `admin_grant` | كسب | إضافة من الإدارة |
| `admin_deduct` | صرف | خصم من الإدارة |
| `points_expiry` | صرف | انتهاء صلاحية |
| `transfer_out` | صرف | تحويل لعميل آخر |
| `transfer_in` | كسب | استلام تحويل |

---

## API Endpoints

### للعملاء
| Endpoint | Method | الوصف |
|----------|--------|-------|
| `/wallet/my-points` | GET | رصيد النقاط والمستوى |
| `/wallet/my-transactions` | GET | سجل معاملات النقاط |
| `/wallet/tiers` | GET | قائمة المستويات والمزايا |

### للإدارة
| Endpoint | Method | الوصف |
|----------|--------|-------|
| `/wallet/admin/customer/:id` | GET | رصيد عميل محدد |
| `/wallet/admin/grant-points` | POST | منح نقاط لعميل |
| `/wallet/admin/tiers` | GET | جميع المستويات |
| `/wallet/admin/tiers` | POST | إنشاء مستوى جديد |
| `/wallet/admin/tiers/:id` | PUT | تعديل مستوى |
| `/wallet/admin/tiers/:id` | DELETE | حذف مستوى |

---

## الأسئلة الشائعة

### كيف أعرف رصيد نقاطي؟
يمكنك معرفة رصيد نقاطك من صفحة المحفظة في التطبيق أو لوحة التحكم.

### متى تُضاف نقاط الطلب؟
تُضاف النقاط تلقائياً عند اكتمال الطلب وتأكيد التسليم.

### هل تنتهي صلاحية النقاط؟
نعم، لكل دفعة نقاط تاريخ انتهاء صلاحية محدد.

### كيف أرتقي لمستوى أعلى؟
يتم الترقية تلقائياً عند تجاوز حد النقاط المطلوب للمستوى التالي.

### هل يمكن تحويل النقاط لشخص آخر؟
نعم، يمكن تحويل النقاط بين العملاء (حسب إعدادات النظام).

---

## ملاحظات تقنية

### قاعدة البيانات
- `loyalty_tiers` - جدول المستويات
- `loyalty_transactions` - جدول معاملات النقاط
- `points_expiry` - جدول تتبع صلاحية النقاط

### الفهارس (Indexes)
- `customerId + createdAt` - للاستعلام السريع عن معاملات العميل
- `expiresAt + isExpired` - لمعالجة النقاط المنتهية
- `code` - للبحث السريع عن المستويات

### Idempotency
- يتم منع تكرار إضافة النقاط لنفس الطلب باستخدام فحص المعاملات السابقة
