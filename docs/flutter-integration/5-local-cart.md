# ğŸ›’ Local Cart Module - Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©

## ğŸ“‹ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Local Cart) ÙŠØ¹Ù…Ù„ ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù…Ù…Ø§ ÙŠÙˆÙØ± ØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø±ÙŠØ¹Ø© ÙˆØ³Ù„Ø³Ø©. ÙŠØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© (Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙØ¹ Ø£Ùˆ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±.

### Ø§Ù„Ù…Ø²Ø§ÙŠØ§ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

- âš¡ **Ø¹Ù…Ù„ÙŠØ§Øª ÙÙˆØ±ÙŠØ©**: Ø¥Ø¶Ø§ÙØ©ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø­Ø°Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÙŠØ±
- ğŸ”„ **Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø°ÙƒÙŠØ©**: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙØ¹
- ğŸ“± **Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª**: Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„
- ğŸ¯ **ØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø³Ù†Ø©**: Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±

---

## ğŸ—ï¸ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ©

### ØªØ¯ÙÙ‚ Ø§Ù„Ø¹Ù…Ù„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…       â”‚
â”‚  ÙŠØ¶ÙŠÙ Ù…Ù†ØªØ¬      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CartCubit       â”‚
â”‚ addToCartLocal()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚LocalDataSource  â”‚
â”‚ Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LocalStorage    â”‚
â”‚ SharedPrefs     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CartCubit       â”‚
â”‚ syncCart()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚RemoteDataSource â”‚
â”‚ POST /cart/sync â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ø§Ù„Ø³ÙŠØ±ÙØ±        â”‚
â”‚  Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†:     â”‚
â”‚  - Ø§Ù„Ù…Ø®Ø²ÙˆÙ†      â”‚
â”‚  - Ø§Ù„Ø£Ø³Ø¹Ø§Ø±      â”‚
â”‚  - Ø§Ù„ØªÙˆÙØ±       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SyncResult      â”‚
â”‚ - Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª      â”‚
â”‚   Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©      â”‚
â”‚ - Ø§Ù„Ø£Ø³Ø¹Ø§Ø±       â”‚
â”‚   Ø§Ù„Ù…ØªØºÙŠØ±Ø©      â”‚
â”‚ - Ø§Ù„ÙƒÙ…ÙŠØ§Øª       â”‚
â”‚   Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

### 1. LocalCartItemModel

Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù†ØµØ± Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠ:

```dart
class LocalCartItemModel {
  final String productId;
  final int quantity;
  final double unitPrice;
  final DateTime addedAt;
  
  // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©ØŒ Ù„Ù„Ø¹Ø±Ø¶)
  final String? productName;
  final String? productNameAr;
  final String? productImage;
  final String? productSku;
  
  double get totalPrice => quantity * unitPrice;
}
```

### 2. CartLocalDataSource

ÙˆØ§Ø¬Ù‡Ø© Ù„Ø­ÙØ¸ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©:

```dart
abstract class CartLocalDataSource {
  Future<List<LocalCartItemModel>> getLocalCart();
  Future<void> saveLocalCart(List<LocalCartItemModel> items);
  Future<List<LocalCartItemModel>> addToCartLocal({...});
  Future<List<LocalCartItemModel>> updateQuantityLocal({...});
  Future<List<LocalCartItemModel>> removeFromCartLocal({...});
  Future<void> clearCartLocal();
  Future<int> getLocalCartCount();
}
```

### 3. CartSyncResultEntity

Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:

```dart
class CartSyncResultEntity {
  final CartEntity syncedCart;
  final List<RemovedCartItem> removedItems;      // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
  final List<PriceChangedCartItem> priceChangedItems;  // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ØªØºÙŠØ± Ø³Ø¹Ø±Ù‡Ø§
  final List<QuantityAdjustedCartItem> quantityAdjustedItems;  // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ…ÙŠØªÙ‡Ø§
  
  bool get hasIssues => 
    removedItems.isNotEmpty || 
    priceChangedItems.isNotEmpty || 
    quantityAdjustedItems.isNotEmpty;
}
```

---

## ğŸš€ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…

### 1. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (ÙÙˆØ±ÙŠØ©)

#### Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø©

```dart
// ÙÙŠ ProductDetailsScreen Ø£Ùˆ Ø£ÙŠ Ø´Ø§Ø´Ø©
context.read<CartCubit>().addToCartLocal(
  productId: product.id,
  quantity: 1,
  unitPrice: product.price,
  productName: product.name,
  productNameAr: product.nameAr,
  productImage: product.image,
  productSku: product.sku,
);

// ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ UI ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø±
```

#### ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©

```dart
// ÙÙŠ CartScreen
context.read<CartCubit>().updateQuantityLocal(
  productId: item.productId,
  quantity: newQuantity,
);

// ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø¹Ø±Ø¶
```

#### Ø­Ø°Ù Ù…Ù†ØªØ¬

```dart
context.read<CartCubit>().removeFromCartLocal(
  productId: item.productId,
);
```

#### ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©

```dart
context.read<CartCubit>().clearCartLocal();
```

### 2. Ø¬Ù„Ø¨ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©

```dart
// ÙÙŠ CartScreen initState
@override
void initState() {
  super.initState();
  context.read<CartCubit>().loadLocalCart();
}
```

### 3. Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ±

#### Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Checkout

```dart
// ÙÙŠ CartScreen
Future<void> _handleCheckout() async {
  // Ø¹Ø±Ø¶ loading
  showDialog(context: context, builder: (_) => LoadingDialog());
  
  // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  final result = await context.read<CartCubit>().syncCart();
  
  // Ø¥ØºÙ„Ø§Ù‚ loading
  Navigator.pop(context);
  
  if (result == null) {
    // ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    showErrorDialog('ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
    return;
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  if (result.hasIssues) {
    // Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    _showSyncIssuesDialog(result);
  } else {
    // Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø¯ÙØ¹
    context.push('/checkout');
  }
}
```

#### Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©

```dart
void _showSyncIssuesDialog(CartSyncResultEntity result) {
  showDialog(
    context: context,
    builder: (context) => AlertDialog(
      title: Text('ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø³Ù„Ø©'),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
          if (result.removedItems.isNotEmpty) ...[
            Text('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:'),
            ...result.removedItems.map((item) => 
              ListTile(
                title: Text(item.productNameAr ?? item.productId),
                subtitle: Text(_getRemovalReason(item.reason)),
              ),
            ),
          ],
          
          // Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ØªØºÙŠØ±Ø©
          if (result.priceChangedItems.isNotEmpty) ...[
            Text('ØªØºÙŠØ±Øª Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:'),
            ...result.priceChangedItems.map((item) => 
              ListTile(
                title: Text(item.productNameAr ?? item.productId),
                subtitle: Text(
                  '${item.oldPrice} â†’ ${item.newPrice}'
                ),
              ),
            ),
          ],
          
          // Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
          if (result.quantityAdjustedItems.isNotEmpty) ...[
            Text('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:'),
            ...result.quantityAdjustedItems.map((item) => 
              ListTile(
                title: Text(item.productNameAr ?? item.productId),
                subtitle: Text(
                  'Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${item.requestedQuantity}\n'
                  'Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©: ${item.availableQuantity}\n'
                  'Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${item.finalQuantity}'
                ),
              ),
            ),
          ],
        ],
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: Text('Ø¥Ù„ØºØ§Ø¡'),
        ),
        ElevatedButton(
          onPressed: () {
            Navigator.pop(context);
            context.push('/checkout');
          },
          child: Text('Ù…ÙˆØ§ÙÙ‚ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©'),
        ),
      ],
    ),
  );
}

String _getRemovalReason(String reason) {
  switch (reason) {
    case 'out_of_stock':
      return 'Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ†';
    case 'deleted':
      return 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬';
    case 'inactive':
      return 'Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªØ§Ø­';
    default:
      return 'ØºÙŠØ± Ù…ØªØ§Ø­';
  }
}
```

### 4. Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„

```dart
// ÙÙŠ AuthRepositoryImpl Ø£Ùˆ AuthCubit
Future<void> login(String phone, String password) async {
  // ... login logic
  
  // Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­
  await context.read<CartCubit>().syncCart(silent: true);
  
  // silent: true ÙŠØ¹Ù†ÙŠ Ø¹Ø¯Ù… Ø¹Ø±Ø¶ loading Ø£Ùˆ Ø£Ø®Ø·Ø§Ø¡
}
```

### 5. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ù„Ø©

```dart
BlocBuilder<CartCubit, CartState>(
  builder: (context, state) {
    if (state is CartLoaded) {
      final cart = state.cart;
      
      return Column(
        children: [
          // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ±
          ...cart.items.map((item) => CartItemWidget(item: item)),
          
          // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
          Text('Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${cart.total}'),
          
          // Ø²Ø± Ø§Ù„Ø¯ÙØ¹
          ElevatedButton(
            onPressed: _handleCheckout,
            child: Text('Ø§Ù„Ø¯ÙØ¹'),
          ),
        ],
      );
    } else if (state is CartSyncing) {
      return CircularProgressIndicator();
    } else if (state is CartSyncCompleted) {
      // Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
      final result = state.syncResult;
      if (result.hasIssues) {
        return _SyncIssuesWidget(result: result);
      }
      return Text('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­');
    } else if (state is CartSyncError) {
      return Text('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${state.message}');
    }
    
    return SizedBox.shrink();
  },
)
```

---

## ğŸ”Œ Backend Integration

### Sync Endpoint

**Endpoint:** `POST /cart/sync`

**Headers:** 
```
Authorization: Bearer <token>
Content-Type: application/json
```

**Request Body:**
```json
{
  "items": [
    {
      "productId": "507f1f77bcf86cd799439011",
      "quantity": 2,
      "unitPrice": 150.00
    },
    {
      "productId": "507f1f77bcf86cd799439012",
      "quantity": 1,
      "unitPrice": 200.00
    }
  ]
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "cart": {
      "_id": "...",
      "customerId": "...",
      "status": "active",
      "items": [
        {
          "productId": "507f1f77bcf86cd799439011",
          "quantity": 2,
          "unitPrice": 150.00,
          "totalPrice": 300.00,
          "addedAt": "2024-01-01T00:00:00Z"
        },
        {
          "productId": "507f1f77bcf86cd799439012",
          "quantity": 1,
          "unitPrice": 180.00,
          "totalPrice": 180.00,
          "addedAt": "2024-01-01T00:00:00Z"
        }
      ],
      "itemsCount": 3,
      "subtotal": 480.00,
      "discount": 0,
      "taxAmount": 0,
      "shippingCost": 0,
      "total": 480.00,
      "couponId": null,
      "couponCode": null,
      "couponDiscount": 0
    },
    "removedItems": [
      {
        "productId": "507f1f77bcf86cd799439013",
        "reason": "out_of_stock",
        "productName": "Product Name",
        "productNameAr": "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"
      }
    ],
    "priceChangedItems": [
      {
        "productId": "507f1f77bcf86cd799439012",
        "oldPrice": 200.00,
        "newPrice": 180.00,
        "productName": "Product Name",
        "productNameAr": "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"
      }
    ],
    "quantityAdjustedItems": [
      {
        "productId": "507f1f77bcf86cd799439011",
        "requestedQuantity": 5,
        "availableQuantity": 2,
        "finalQuantity": 2,
        "productName": "Product Name",
        "productNameAr": "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"
      }
    ]
  },
  "message": "Cart synced successfully",
  "messageAr": "ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­"
}
```

---

## ğŸ“ Best Practices

### 1. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹

```dart
// âœ… ØµØ­ÙŠØ­ - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
context.read<CartCubit>().addToCartLocal(...);

// âŒ Ø®Ø§Ø·Ø¦ - Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨Ø¹ÙŠØ¯Ø© Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
context.read<CartCubit>().addToCart(...);  // Ù‡Ø°Ø§ Ø¨Ø·ÙŠØ¡!
```

### 2. Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©

```dart
// âœ… ØµØ­ÙŠØ­ - Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹
await cartCubit.syncCart();

// âŒ Ø®Ø§Ø·Ø¦ - Ù„Ø§ ØªØ²Ø§Ù…Ù† Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©
await cartCubit.addToCartLocal(...);
await cartCubit.syncCart();  // Ù„Ø§ Ø­Ø§Ø¬Ø©!
```

### 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©

```dart
// âœ… ØµØ­ÙŠØ­ - Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
final result = await cartCubit.syncCart();
if (result?.hasIssues == true) {
  _showSyncIssuesDialog(result!);
}

// âŒ Ø®Ø§Ø·Ø¦ - ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
await cartCubit.syncCart();  // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠØ¹Ù„Ù… Ø¨Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª!
```

### 4. Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ Ø§Ù„Ø¹Ù†ØµØ±

```dart
// âœ… ØµØ­ÙŠØ­ - Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø¹Ø±Ø¶
await cartCubit.addToCartLocal(
  productId: product.id,
  quantity: 1,
  unitPrice: product.price,
  productName: product.name,
  productNameAr: product.nameAr,
  productImage: product.image,
);

// âŒ Ø®Ø§Ø·Ø¦ - Ø­ÙØ¸ ÙÙ‚Ø· productId
await cartCubit.addToCartLocal(
  productId: product.id,  // ÙÙ‚Ø·! Ø³ØªØ­ØªØ§Ø¬ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„Ø¹Ø±Ø¶
  quantity: 1,
  unitPrice: product.price,
);
```

### 5. Ø§Ø³ØªØ®Ø¯Ø§Ù… Silent Sync Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©

```dart
// âœ… ØµØ­ÙŠØ­ - silent sync Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
await cartCubit.syncCart(silent: true);

// âœ… ØµØ­ÙŠØ­ - sync Ø¹Ø§Ø¯ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹
await cartCubit.syncCart();  // silent: false (default)
```

---

## ğŸ”„ ØªØ¯ÙÙ‚ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠ

### 1. Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹

```
Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â†’ Checkout Button
    â†“
CartCubit.syncCart()
    â†“
CartSyncing State (Ø¹Ø±Ø¶ loading)
    â†“
LocalDataSource.getLocalCart()
    â†“
RemoteDataSource.syncCartWithResults()
    â†“
POST /cart/sync
    â†“
Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØªØ­Ù‚Ù‚ Ù…Ù†:
    - ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆÙ†Ø´Ø§Ø·Ù‡
    - Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­
    - Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
    â†“
CartSyncResultEntity
    â†“
LocalDataSource.saveLocalCart() (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©)
    â†“
CartSyncCompleted State
    â†“
Ø¥Ø°Ø§ hasIssues:
    - Ø¹Ø±Ø¶ Dialog Ù…Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    - Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    â†“
Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø¯ÙØ¹
```

### 2. Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„

```
Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â†’ Login
    â†“
AuthRepository.login()
    â†“
Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Login
    â†“
CartCubit.syncCart(silent: true)
    â†“
LocalDataSource.getLocalCart()
    â†“
RemoteDataSource.syncCartWithResults()
    â†“
Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¯Ù…Ø¬ Ø§Ù„Ø³Ù„Ø§Øª (Ø§Ù„Ù…Ø­Ù„ÙŠØ© + Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±)
    â†“
LocalDataSource.saveLocalCart() (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©)
    â†“
CartSyncCompleted (Ø¨Ø¯ÙˆÙ† Ø¥Ø´Ø¹Ø§Ø±Ø§Øª)
```

---

## âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©

1. **Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª**: Ù„Ø§ ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª ÙŠÙƒÙˆÙ† ÙÙ‚Ø· ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯ÙØ¹.

2. **Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ**: ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© Ù…Ø­Ù„ÙŠØ©.

3. **Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡**: Ø¹Ù†Ø¯ ÙØ´Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©ØŒ ØªØ¨Ù‚Ù‰ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙƒÙ…Ø§ Ù‡ÙŠ.

4. **Ø§Ù„ØªØ²Ø§Ù…Ù†**: Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯ØŒ ÙŠØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø³Ù„Ø§Øª (Ø§Ù„Ù…Ø­Ù„ÙŠØ© + Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±).

5. **Ø§Ù„Ø£Ø¯Ø§Ø¡**: Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ£Ø®ÙŠØ±.

6. **Ø§Ù„ØªØ®Ø²ÙŠÙ†**: Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ `SharedPreferences` Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ `cart_items`.

---

## ğŸ“š Ø£Ù…Ø«Ù„Ø© ÙƒØ§Ù…Ù„Ø©

### Ù…Ø«Ø§Ù„: ProductDetailsScreen

```dart
class ProductDetailsScreen extends StatelessWidget {
  final ProductEntity product;
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Column(
        children: [
          // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬
          ProductDetails(product: product),
          
          // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
          ElevatedButton(
            onPressed: () {
              context.read<CartCubit>().addToCartLocal(
                productId: product.id,
                quantity: 1,
                unitPrice: product.price,
                productName: product.name,
                productNameAr: product.nameAr,
                productImage: product.images.firstOrNull,
                productSku: product.sku,
              );
              
              // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©')),
              );
            },
            child: Text('Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©'),
          ),
        ],
      ),
    );
  }
}
```

### Ù…Ø«Ø§Ù„: CartScreen ÙƒØ§Ù…Ù„

```dart
class CartScreen extends StatefulWidget {
  @override
  State<CartScreen> createState() => _CartScreenState();
}

class _CartScreenState extends State<CartScreen> {
  @override
  void initState() {
    super.initState();
    // Ø¬Ù„Ø¨ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    context.read<CartCubit>().loadLocalCart();
  }
  
  Future<void> _handleCheckout() async {
    // Ø¹Ø±Ø¶ loading
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (_) => Center(child: CircularProgressIndicator()),
    );
    
    // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    final result = await context.read<CartCubit>().syncCart();
    
    // Ø¥ØºÙ„Ø§Ù‚ loading
    Navigator.pop(context);
    
    if (result == null) {
      // ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.')),
      );
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    if (result.hasIssues) {
      // Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
      await _showSyncIssuesDialog(result);
    } else {
      // Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø¯ÙØ¹
      context.push('/checkout');
    }
  }
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Ø§Ù„Ø³Ù„Ø©')),
      body: BlocBuilder<CartCubit, CartState>(
        builder: (context, state) {
          if (state is CartLoaded) {
            final cart = state.cart;
            
            if (cart.isEmpty) {
              return Center(child: Text('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'));
            }
            
            return Column(
              children: [
                // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±
                Expanded(
                  child: ListView.builder(
                    itemCount: cart.items.length,
                    itemBuilder: (context, index) {
                      final item = cart.items[index];
                      return CartItemCard(
                        item: item,
                        onQuantityChanged: (newQuantity) {
                          context.read<CartCubit>().updateQuantityLocal(
                            item.productId,
                            newQuantity,
                          );
                        },
                        onRemove: () {
                          context.read<CartCubit>().removeFromCartLocal(
                            item.productId,
                          );
                        },
                      );
                    },
                  ),
                ),
                
                // Ø§Ù„Ù…Ù„Ø®Øµ
                CartSummary(cart: cart),
                
                // Ø²Ø± Ø§Ù„Ø¯ÙØ¹
                Padding(
                  padding: EdgeInsets.all(16),
                  child: ElevatedButton(
                    onPressed: _handleCheckout,
                    style: ElevatedButton.styleFrom(
                      minimumSize: Size(double.infinity, 50),
                    ),
                    child: Text('Ø§Ù„Ø¯ÙØ¹'),
                  ),
                ),
              ],
            );
          } else if (state is CartSyncing) {
            return Center(child: CircularProgressIndicator());
          } else if (state is CartSyncCompleted) {
            // Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
            return build(context);  // rebuild
          }
          
          return Center(child: CircularProgressIndicator());
        },
      ),
    );
  }
}
```

---

## ğŸ› Troubleshooting

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ø§Ù„Ø³Ù„Ø© Ù„Ø§ ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©

**Ø§Ù„Ø­Ù„:**
```dart
// ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ loadLocalCart() ÙÙŠ initState
@override
void initState() {
  super.initState();
  context.read<CartCubit>().loadLocalCart();
}
```

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØªÙØ´Ù„

**Ø§Ù„Ø­Ù„:**
```dart
// ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ token
// ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
// ØªØ­Ù‚Ù‚ Ù…Ù† format Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©
```

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ø§ ØªØ²Ø§Ù…Ù† Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ±

**Ø§Ù„Ø­Ù„:**
```dart
// ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ syncCart() Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙØ¹
// ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† syncCartWithResults() Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ RemoteDataSource
```

---

## ğŸ“ Ø§Ù„Ø¯Ø¹Ù…

Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ùˆ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰:
- [Orders Module Documentation](./orders.md)
- [API Documentation](../../backend/README.md)

---

**Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:** 2024-01-01
