# ğŸ Products on Offer - Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø°Ø§Øª Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©

## ğŸ“‹ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„ ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹:
- âœ… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø¯ÙŠÙ‡Ø§ Ø¹Ø±ÙˆØ¶ Ù…Ø¨Ø§Ø´Ø±Ø© (compareAtPrice > basePrice)
- âœ… Ù†Ø¸Ø§Ù… Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¹Ø±ÙˆØ¶
- âœ… Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø°Ø§Øª Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù…Ø¹ Pagination Ùˆ Sorting Ùˆ Filtering

> **Ù…Ù„Ø§Ø­Ø¸Ø©**: Ø§Ù„Ù€ endpoint **Ø¹Ø§Ù…** ğŸŒ ÙˆÙ„Ø§ ÙŠØ­ØªØ§Ø¬ Token

---

## ğŸ¯ Ù†Ø¸Ø§Ù… Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¹Ø±ÙˆØ¶

### ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© (Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ù‚Ù„):

1. **Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±** (Ø£Ø¹Ù„Ù‰ Ø£ÙˆÙ„ÙˆÙŠØ©) ğŸ”¥
   - Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† `compareAtPrice > basePrice`
   - Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù‡ Ø£ÙˆÙ„ÙˆÙŠØ© Ù…Ø·Ù„Ù‚Ø©
   - **Ù„Ø§ ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø£ÙŠ Ø¹Ø±ÙˆØ¶ Ø£Ø®Ø±Ù‰** Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù‡ Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø±

2. **Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ Ù…Ø­Ø¯Ø¯** (Product-specific)
   - Ø¹Ø±ÙˆØ¶ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù…Ù†ØªØ¬ Ù…Ø¹ÙŠÙ† Ø¹Ø¨Ø± `productIds`

3. **Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„ÙØ¦Ø©** (Category)
   - Ø¹Ø±ÙˆØ¶ Ù…Ø±ØªØ¨Ø·Ø© Ø¨ÙØ¦Ø© Ø§Ù„Ù…Ù†ØªØ¬

4. **Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§Ø±ÙƒØ©** (Brand)
   - Ø¹Ø±ÙˆØ¶ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù…Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬

5. **Ø¹Ø±Ø¶ Ø¹Ø§Ù…** (General)
   - Ø¹Ø±ÙˆØ¶ ØªØ·Ø¨Ù‚ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (`scope: 'all'`)

### Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠ:

```
Ù…Ù†ØªØ¬: iPhone 15 Pro
- basePrice: 3,500 Ø±ÙŠØ§Ù„
- compareAtPrice: 4,000 Ø±ÙŠØ§Ù„
- categoryId: "smartphones"
- brandId: "apple"

Ø¹Ø±ÙˆØ¶ Ù…ØªØ§Ø­Ø©:
- Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ ÙØ¦Ø© "smartphones": Ø®ØµÙ… 10%
- Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ù…Ø§Ø±ÙƒØ© "apple": Ø®ØµÙ… 5%

Ø§Ù„Ù†ØªÙŠØ¬Ø©:
âœ… ÙŠØ¹Ø±Ø¶: Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… 4,000 Ø±ÙŠØ§Ù„ ÙˆØ§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ 3,500 Ø±ÙŠØ§Ù„
âŒ Ù„Ø§ ÙŠØ·Ø¨Ù‚ Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø© (10%)
âŒ Ù„Ø§ ÙŠØ·Ø¨Ù‚ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø§Ø±ÙƒØ© (5%)
```

---

## ğŸ“ Flutter Models

> **Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:** ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… `Product` model Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ `products.md` Ù…Ø¨Ø§Ø´Ø±Ø©. Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ÙŠÙØ±Ø¬Ø¹ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Product Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (`hasDirectOffer`, `originalPrice`, `currentPrice`, `discountPercentage`, `appliedPromotion`). ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… extension Ø£Ø¯Ù†Ø§Ù‡ Ø£Ùˆ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† JSON.

### Product with Offer Model Extension

```dart
// Extension Ø¹Ù„Ù‰ Product Model Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
extension ProductOfferExtension on Product {
  /// Ù‡Ù„ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù‡ Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø±ØŸ
  bool get hasDirectOffer {
    return compareAtPrice != null && 
           compareAtPrice! > basePrice;
  }

  /// Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…
  double get discountPercentage {
    if (!hasDirectOffer) return 0.0;
    return ((compareAtPrice! - basePrice) / compareAtPrice!) * 100;
  }

  /// Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ (Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…)
  double get originalPrice => compareAtPrice ?? basePrice;

  /// Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…)
  double get currentPrice => basePrice;

  /// Ù†Øµ Ø§Ù„Ø®ØµÙ… Ù„Ù„Ø¹Ø±Ø¶
  String get discountText {
    if (!hasDirectOffer) return '';
    final discount = discountPercentage.round();
    return 'Ø®ØµÙ… $discount%';
  }

  /// Ù‡Ù„ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¢Ù†ØŸ
  bool get isOnOffer => hasDirectOffer;
}
```

### Product Response with Offer Fields (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)

> **Ù…Ù„Ø§Ø­Ø¸Ø©:** Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ÙŠÙØ±Ø¬Ø¹ `Product` objects Ø¹Ø§Ø¯ÙŠØ© Ù…Ø¹ Ø­Ù‚ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠØ©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… `Product.fromJson()` Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ù† JSON.

Ø¹Ù†Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† endpoint `/products/on-offer`ØŒ Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ JSON:

```dart
// ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Product model Ù…Ø¨Ø§Ø´Ø±Ø© Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ extension
class ProductWithOffer {
  // Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Product Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
  final String id;
  final String name;
  final String nameAr;
  final double basePrice;
  final double? compareAtPrice;
  // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„

  // Ø­Ù‚ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¹Ø±ÙˆØ¶
  final bool hasDirectOffer;        // Ø¯Ø§Ø¦Ù…Ø§Ù‹ true ÙÙŠ Ù‡Ø°Ø§ endpoint
  final double originalPrice;       // compareAtPrice
  final double currentPrice;        // basePrice
  final double discountPercentage;  // Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©
  final dynamic appliedPromotion;   // null (Ù„Ø£Ù†Ù‡ Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø±)

  ProductWithOffer({
    // ... Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
    required this.hasDirectOffer,
    required this.originalPrice,
    required this.currentPrice,
    required this.discountPercentage,
    this.appliedPromotion,
  });

  factory ProductWithOffer.fromJson(Map<String, dynamic> json) {
    return ProductWithOffer(
      id: json['_id'] ?? json['id'],
      name: json['name'],
      nameAr: json['nameAr'],
      basePrice: json['basePrice']?.toDouble() ?? 0.0,
      compareAtPrice: json['compareAtPrice']?.toDouble(),
      // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„
      hasDirectOffer: json['hasDirectOffer'] ?? false,
      originalPrice: json['originalPrice']?.toDouble() ?? json['compareAtPrice']?.toDouble() ?? 0.0,
      currentPrice: json['currentPrice']?.toDouble() ?? json['basePrice']?.toDouble() ?? 0.0,
      discountPercentage: json['discountPercentage'] != null
          ? (json['discountPercentage'] is double
              ? json['discountPercentage']
              : json['discountPercentage'].toDouble())
          : (json['compareAtPrice'] != null && json['basePrice'] != null
              ? ((json['compareAtPrice'] - json['basePrice']) / json['compareAtPrice']) * 100
              : 0.0),
      appliedPromotion: json['appliedPromotion'], // Ø¯Ø§Ø¦Ù…Ø§Ù‹ null
    );
  }
}
```

**Ù…Ù„Ø§Ø­Ø¸Ø©:** ÙŠÙˆØµÙ‰ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… `Product` model Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø¹ extension Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ class Ø¬Ø¯ÙŠØ¯. Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ÙŠÙØ±Ø¬Ø¹:
- Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ `Product` Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
- Ø­Ù‚ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠØ©: `hasDirectOffer` (Ø¯Ø§Ø¦Ù…Ø§Ù‹ true), `originalPrice`, `currentPrice`, `discountPercentage`, `appliedPromotion` (Ø¯Ø§Ø¦Ù…Ø§Ù‹ null)

---

## ğŸ”Œ API Endpoints

### 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø°Ø§Øª Ø§Ù„Ø¹Ø±ÙˆØ¶

```http
GET /products/on-offer
```

**Query Parameters:**

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `page` | number | No | 1 | Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© |
| `limit` | number | No | 20 | Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø© (1-100) |
| `sortBy` | string | No | 'discount' | Ù†ÙˆØ¹ Ø§Ù„ØªØ±ØªÙŠØ¨: 'discount', 'price', 'createdAt' |
| `sortOrder` | string | No | 'desc' | Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ±ØªÙŠØ¨: 'asc', 'desc' |
| `minDiscount` | number | No | - | Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (0-100) |
| `maxDiscount` | number | No | - | Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (0-100) |
| `categoryId` | string | No | - | ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© (MongoDB ID) |
| `brandId` | string | No | - | ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø±ÙƒØ© (MongoDB ID) |
| `status` | string | No | 'active' | Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ (Ø§ÙØªØ±Ø§Ø¶ÙŠ: 'active') |

**Ù…Ù„Ø§Ø­Ø¸Ø§Øª:**
- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙØ±Ø¬Ø¹Ø© Ù„Ø¯ÙŠÙ‡Ø§ `compareAtPrice > basePrice` (Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø±)
- ÙŠØªÙ… Ø­Ø³Ø§Ø¨ `discountPercentage` ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ£ØªÙŠ Ù…Ø¹ populate Ù„Ù„Ø¹Ù„Ø§Ù‚Ø§Øª (brandId, categoryId, qualityTypeId)
- Ø§Ù„Ø­Ù‚Ù„ `appliedPromotion` Ø¯Ø§Ø¦Ù…Ø§Ù‹ `null` Ù„Ø£Ù† Ù‡Ø°Ù‡ Ø¹Ø±ÙˆØ¶ Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆÙ„ÙŠØ³Øª Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø±ÙˆØ¶

**Response:**

```json
{
  "success": true,
  "message": "Products on offer retrieved",
  "messageAr": "ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø°Ø§Øª Ø§Ù„Ø¹Ø±ÙˆØ¶",
  "data": [
    {
      "_id": "507f1f77bcf86cd799439011",
      "name": "iPhone 15 Pro Max",
      "nameAr": "Ø¢ÙŠÙÙˆÙ† 15 Ø¨Ø±Ùˆ Ù…Ø§ÙƒØ³",
      "basePrice": 3500,
      "compareAtPrice": 4000,
      "hasDirectOffer": true,
      "originalPrice": 4000,
      "currentPrice": 3500,
      "discountPercentage": 12.5,
      "appliedPromotion": null,
      "brandId": {
        "_id": "...",
        "name": "Apple",
        "nameAr": "Ø£Ø¨Ù„",
        "slug": "apple"
      },
      "categoryId": {
        "_id": "...",
        "name": "Smartphones",
        "nameAr": "Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ø°ÙƒÙŠØ©",
        "slug": "smartphones"
      },
      "qualityTypeId": {
        "_id": "...",
        "name": "Original",
        "nameAr": "Ø£ØµÙ„ÙŠ",
        "code": "original",
        "color": "#22c55e"
      }
      // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Product Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)
    }
  ],
  "meta": {
    "page": 1,
    "limit": 20,
    "pages": 5,
    "total": 95
  }
}
```

---

## ğŸ’» Flutter Implementation

### 1. Data Source

```dart
// lib/features/products/data/datasources/products_remote_datasource.dart

abstract class ProductsRemoteDataSource {
  Future<Map<String, dynamic>> getProductsOnOffer({
    int page = 1,
    int limit = 20,
    String sortBy = 'discount',
    String sortOrder = 'desc',
    double? minDiscount,
    double? maxDiscount,
    String? categoryId,
    String? brandId,
  });
}

class ProductsRemoteDataSourceImpl implements ProductsRemoteDataSource {
  final Dio dio;

  ProductsRemoteDataSourceImpl({required this.dio});

  @override
  Future<Map<String, dynamic>> getProductsOnOffer({
    int page = 1,
    int limit = 20,
    String sortBy = 'discount',
    String sortOrder = 'desc',
    double? minDiscount,
    double? maxDiscount,
    String? categoryId,
    String? brandId,
  }) async {
    final queryParams = <String, dynamic>{
      'page': page,
      'limit': limit,
      'sortBy': sortBy,
      'sortOrder': sortOrder,
    };

    if (minDiscount != null) queryParams['minDiscount'] = minDiscount;
    if (maxDiscount != null) queryParams['maxDiscount'] = maxDiscount;
    if (categoryId != null) queryParams['categoryId'] = categoryId;
    if (brandId != null) queryParams['brandId'] = brandId;

    final response = await dio.get(
      '/products/on-offer',
      queryParameters: queryParams,
    );

    if (response.data['success']) {
      final data = response.data['data'] as List;
      final products = data.map((json) => Product.fromJson(json)).toList();
      return {
        'products': products,
        'pagination': response.data['meta'],
      };
    }
    throw Exception(response.data['messageAr'] ?? 'Failed to load products');
  }
}
```

### 2. Repository

```dart
// lib/features/products/domain/repositories/products_repository.dart

abstract class ProductsRepository {
  Future<Either<Failure, PaginatedResponse<Product>>> getProductsOnOffer({
    int page = 1,
    int limit = 20,
    String sortBy = 'discount',
    String sortOrder = 'desc',
    double? minDiscount,
    double? maxDiscount,
    String? categoryId,
    String? brandId,
  });
}

// lib/features/products/data/repositories/products_repository_impl.dart

class ProductsRepositoryImpl implements ProductsRepository {
  final ProductsRemoteDataSource remoteDataSource;

  ProductsRepositoryImpl({required this.remoteDataSource});

  @override
  Future<Either<Failure, PaginatedResponse<Product>>> getProductsOnOffer({
    int page = 1,
    int limit = 20,
    String sortBy = 'discount',
    String sortOrder = 'desc',
    double? minDiscount,
    double? maxDiscount,
    String? categoryId,
    String? brandId,
  }) async {
    try {
      final result = await remoteDataSource.getProductsOnOffer(
        page: page,
        limit: limit,
        sortBy: sortBy,
        sortOrder: sortOrder,
        minDiscount: minDiscount,
        maxDiscount: maxDiscount,
        categoryId: categoryId,
        brandId: brandId,
      );

      final products = result['products'] as List<Product>;
      final pagination = result['pagination'] as Map<String, dynamic>;
      
      return Right(PaginatedResponse(
        data: products,
        page: pagination['page'] ?? page,
        limit: pagination['limit'] ?? limit,
        total: pagination['total'] ?? 0,
        pages: pagination['pages'] ?? 1,
      ));
    } catch (e) {
      return Left(ServerFailure(message: e.toString()));
    }
  }
}
```

### 3. Use Case

```dart
// lib/features/products/domain/usecases/get_products_on_offer.dart

class GetProductsOnOffer {
  final ProductsRepository repository;

  GetProductsOnOffer(this.repository);

  Future<Either<Failure, PaginatedResponse<ProductWithOffer>>> call({
    int page = 1,
    int limit = 20,
    String sortBy = 'discount',
    String sortOrder = 'desc',
    double? minDiscount,
    double? maxDiscount,
    String? categoryId,
    String? brandId,
  }) {
    return repository.getProductsOnOffer(
      page: page,
      limit: limit,
      sortBy: sortBy,
      sortOrder: sortOrder,
      minDiscount: minDiscount,
      maxDiscount: maxDiscount,
      categoryId: categoryId,
      brandId: brandId,
    );
  }
}
```

### 4. Bloc/Cubit

```dart
// lib/features/products/presentation/cubit/products_on_offer_cubit.dart

class ProductsOnOfferCubit extends Cubit<ProductsOnOfferState> {
  final GetProductsOnOffer getProductsOnOffer;

  ProductsOnOfferCubit({required this.getProductsOnOffer}) 
      : super(ProductsOnOfferInitial());

  int currentPage = 1;
  bool hasMore = true;
  List<Product> products = [];
  
  String sortBy = 'discount';
  String sortOrder = 'desc';
  double? minDiscount;
  double? maxDiscount;
  String? categoryId;
  String? brandId;

  Future<void> loadProducts({bool refresh = false}) async {
    if (refresh) {
      currentPage = 1;
      products.clear();
      hasMore = true;
    }

    if (!hasMore) return;

    emit(ProductsOnOfferLoading());

    final result = await getProductsOnOffer(
      page: currentPage,
      limit: 20,
      sortBy: sortBy,
      sortOrder: sortOrder,
      minDiscount: minDiscount,
      maxDiscount: maxDiscount,
      categoryId: categoryId,
      brandId: brandId,
    );

    result.fold(
      (failure) => emit(ProductsOnOfferError(failure.message)),
      (response) {
        products.addAll(response.data);
        hasMore = currentPage < response.pages;
        currentPage++;
        emit(ProductsOnOfferLoaded(products: products, hasMore: hasMore));
      },
    );
  }

  void updateFilters({
    String? sortBy,
    String? sortOrder,
    double? minDiscount,
    double? maxDiscount,
    String? categoryId,
    String? brandId,
  }) {
    this.sortBy = sortBy ?? this.sortBy;
    this.sortOrder = sortOrder ?? this.sortOrder;
    this.minDiscount = minDiscount;
    this.maxDiscount = maxDiscount;
    this.categoryId = categoryId;
    this.brandId = brandId;
    loadProducts(refresh: true);
  }
}

// States
abstract class ProductsOnOfferState {}

class ProductsOnOfferInitial extends ProductsOnOfferState {}

class ProductsOnOfferLoading extends ProductsOnOfferState {}

class ProductsOnOfferLoaded extends ProductsOnOfferState {
  final List<Product> products;
  final bool hasMore;

  ProductsOnOfferLoaded({required this.products, required this.hasMore});
}

class ProductsOnOfferError extends ProductsOnOfferState {
  final String message;

  ProductsOnOfferError(this.message);
}
```

---

## ğŸ¨ UI Components

### 1. Product Offer Card

```dart
// lib/features/products/presentation/widgets/product_offer_card.dart

class ProductOfferCard extends StatelessWidget {
  final Product product;

  const ProductOfferCard({Key? key, required this.product}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Card(
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ Ø´Ø§Ø±Ø© Ø§Ù„Ø®ØµÙ…
          Stack(
            children: [
              Image.network(
                product.mainImage ?? '',
                height: 200,
                width: double.infinity,
                fit: BoxFit.cover,
              ),
              // Ø´Ø§Ø±Ø© Ø§Ù„Ø®ØµÙ…
              Positioned(
                top: 8,
                right: 8,
                child: Container(
                  padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: Colors.red,
                    borderRadius: BorderRadius.circular(4),
                  ),
                  child: Text(
                    'Ø®ØµÙ… ${product.hasDiscount ? product.discountPercentage.round() : 0}%',
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 12,
                    ),
                  ),
                ),
              ),
            ],
          ),
          
          Padding(
            padding: EdgeInsets.all(12),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
                Text(
                  product.nameAr,
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
                
                SizedBox(height: 8),
                
                // Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
                Row(
                  children: [
                    // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ù…Ø´Ø·ÙˆØ¨)
                    if (product.hasDiscount && product.compareAtPrice != null)
                      Text(
                        '${product.compareAtPrice!.toStringAsFixed(0)} Ø±.Ø³',
                        style: TextStyle(
                          decoration: TextDecoration.lineThrough,
                          color: Colors.grey,
                          fontSize: 14,
                        ),
                      ),
                    if (product.hasDiscount && product.compareAtPrice != null)
                      SizedBox(width: 8),
                    // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    Text(
                      '${product.basePrice.toStringAsFixed(0)} Ø±.Ø³',
                      style: TextStyle(
                        color: Colors.red,
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
                
                SizedBox(height: 4),
                
                // Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…
                if (product.hasDiscount && product.compareAtPrice != null)
                  Text(
                    'ÙˆÙØ± ${(product.compareAtPrice! - product.basePrice).toStringAsFixed(0)} Ø±.Ø³',
                  style: TextStyle(
                    color: Colors.green,
                    fontSize: 12,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
```

### 2. Products on Offer Screen

```dart
// lib/features/products/presentation/screens/products_on_offer_screen.dart

class ProductsOnOfferScreen extends StatefulWidget {
  @override
  _ProductsOnOfferScreenState createState() => _ProductsOnOfferScreenState();
}

class _ProductsOnOfferScreenState extends State<ProductsOnOfferScreen> {
  final ProductsOnOfferCubit _cubit = GetIt.instance<ProductsOnOfferCubit>();
  final ScrollController _scrollController = ScrollController();

  @override
  void initState() {
    super.initState();
    _cubit.loadProducts();
    _scrollController.addListener(_onScroll);
  }

  void _onScroll() {
    if (_scrollController.position.pixels >= 
        _scrollController.position.maxScrollExtent * 0.9) {
      _cubit.loadProducts();
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('Ø§Ù„Ø¹Ø±ÙˆØ¶'),
        actions: [
          IconButton(
            icon: Icon(Icons.filter_list),
            onPressed: () => _showFilterDialog(),
          ),
        ],
      ),
      body: BlocBuilder<ProductsOnOfferCubit, ProductsOnOfferState>(
        bloc: _cubit,
        builder: (context, state) {
          if (state is ProductsOnOfferLoading && _cubit.products.isEmpty) {
            return Center(child: CircularProgressIndicator());
          }

          if (state is ProductsOnOfferError) {
            return Center(child: Text(state.message));
          }

          if (state is ProductsOnOfferLoaded) {
            if (state.products.isEmpty) {
              return Center(child: Text('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…ØªØ§Ø­Ø©'));
            }

            return RefreshIndicator(
              onRefresh: () => _cubit.loadProducts(refresh: true),
              child: GridView.builder(
                controller: _scrollController,
                padding: EdgeInsets.all(8),
                gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                  crossAxisCount: 2,
                  childAspectRatio: 0.7,
                  crossAxisSpacing: 8,
                  mainAxisSpacing: 8,
                ),
                itemCount: state.products.length + (state.hasMore ? 1 : 0),
                itemBuilder: (context, index) {
                  if (index >= state.products.length) {
                    return Center(child: CircularProgressIndicator());
                  }
                  return ProductOfferCard(product: state.products[index]);
                },
              ),
            );
          }

          return SizedBox.shrink();
        },
      ),
    );
  }

  void _showFilterDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('ØªØµÙÙŠØ© Ø§Ù„Ø¹Ø±ÙˆØ¶'),
        content: SingleChildScrollView(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Sort By
              DropdownButtonFormField<String>(
                value: _cubit.sortBy,
                decoration: InputDecoration(labelText: 'ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨'),
                items: [
                  DropdownMenuItem(value: 'discount', child: Text('Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…')),
                  DropdownMenuItem(value: 'price', child: Text('Ø§Ù„Ø³Ø¹Ø±')),
                  DropdownMenuItem(value: 'createdAt', child: Text('Ø§Ù„Ø£Ø­Ø¯Ø«')),
                ],
                onChanged: (value) {
                  if (value != null) {
                    _cubit.updateFilters(sortBy: value);
                    Navigator.pop(context);
                  }
                },
              ),
              
              SizedBox(height: 16),
              
              // Min Discount
              TextField(
                decoration: InputDecoration(
                  labelText: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ… (%)',
                ),
                keyboardType: TextInputType.number,
                onChanged: (value) {
                  final discount = double.tryParse(value);
                  _cubit.updateFilters(minDiscount: discount);
                },
              ),
              
              SizedBox(height: 16),
              
              // Max Discount
              TextField(
                decoration: InputDecoration(
                  labelText: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø®ØµÙ… (%)',
                ),
                keyboardType: TextInputType.number,
                onChanged: (value) {
                  final discount = double.tryParse(value);
                  _cubit.updateFilters(maxDiscount: discount);
                },
              ),
            ],
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('Ø¥Ù„ØºØ§Ø¡'),
          ),
          TextButton(
            onPressed: () {
              _cubit.loadProducts(refresh: true);
              Navigator.pop(context);
            },
            child: Text('ØªØ·Ø¨ÙŠÙ‚'),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }
}
```

---

## ğŸ“Š Ø£Ù…Ø«Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…

### Ù…Ø«Ø§Ù„ 1: Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø°Ø§Øª Ø§Ù„Ø¹Ø±ÙˆØ¶

```dart
final cubit = GetIt.instance<ProductsOnOfferCubit>();
await cubit.loadProducts();
```

### Ù…Ø«Ø§Ù„ 2: ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…

```dart
// Ø¹Ø±ÙˆØ¶ Ø¨Ø®ØµÙ… Ù…Ù† 10% Ø¥Ù„Ù‰ 50%
cubit.updateFilters(
  minDiscount: 10,
  maxDiscount: 50,
);
```

### Ù…Ø«Ø§Ù„ 3: ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø±

```dart
cubit.updateFilters(
  sortBy: 'price',
  sortOrder: 'asc', // Ù…Ù† Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø£Ø¹Ù„Ù‰
);
```

### Ù…Ø«Ø§Ù„ 4: ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©

```dart
cubit.updateFilters(
  categoryId: '507f1f77bcf86cd799439011',
);
```

---

## ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬

Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ Ø£ÙŠ Ù…Ù†ØªØ¬ØŒ ÙŠØ¬Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø± Ø£ÙˆÙ„Ø§Ù‹:

```dart
// ÙÙŠ Product Details Screen
void checkProductOffer(Product product) {
  if (product.hasDirectOffer) {
    // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯
    // Ù„Ø§ ØªØ·Ø¨Ù‚ Ø£ÙŠ Ø¹Ø±ÙˆØ¶ Ø£Ø®Ø±Ù‰
    showOfferBadge(product.discountPercentage);
  } else {
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø®Ø±Ù‰ (Ù…Ù† PromotionsService)
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
    loadProductPromotions(product);
  }
}
```

---

## ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©

1. **Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±**: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù‡ `compareAtPrice > basePrice`ØŒ Ù„Ø§ ØªØ·Ø¨Ù‚ Ø£ÙŠ Ø¹Ø±ÙˆØ¶ Ø£Ø®Ø±Ù‰ Ø¹Ù„ÙŠÙ‡.

2. **Endpoint `/products/on-offer`**: ÙŠØ¹ÙŠØ¯ ÙÙ‚Ø· Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø¯ÙŠÙ‡Ø§ Ø¹Ø±ÙˆØ¶ Ù…Ø¨Ø§Ø´Ø±Ø©.

3. **Pagination**: Ø§Ø³ØªØ®Ø¯Ù… pagination Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø¹Ø¯Ø¯ ÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.

4. **Caching**: ÙŠÙ…ÙƒÙ†Ùƒ cache Ù†ØªØ§Ø¦Ø¬ `/products/on-offer` Ù„Ø£Ù†Ù‡Ø§ Ù„Ø§ ØªØªØºÙŠØ± ÙƒØ«ÙŠØ±Ø§Ù‹.

5. **Real-time Updates**: Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ±ÙŠØ©ØŒ Ø§Ø³ØªØ®Ø¯Ù… WebSocket Ø£Ùˆ Polling.

---

## ğŸ¯ Best Practices

1. **Ø§Ø³ØªØ®Ø¯Ù… Infinite Scroll**: Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
2. **Ø£Ø¶Ù Pull to Refresh**: Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
3. **Ø¹Ø±Ø¶ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… Ø¨ÙˆØ¶ÙˆØ­**: Ø§Ø³ØªØ®Ø¯Ù… Ø£Ù„ÙˆØ§Ù† Ø¬Ø°Ø§Ø¨Ø© Ù„Ù„Ø´Ø§Ø±Ø§Øª
4. **Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ø´Ø·ÙˆØ¨**: Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥Ù‚Ù†Ø§Ø¹
5. **Ø£Ø¶Ù Ø¹Ø¯Ø§Ø¯ Ù„Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ**: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹ ÙÙŠ API

---

## ğŸ”— Ø±ÙˆØ§Ø¨Ø· Ø°Ø§Øª ØµÙ„Ø©

- [Promotions Module](./promotions.md) - Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª
- [Products Module](./products.md) - Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
- [Catalog Module](./catalog.md) - Ø¯Ù„ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬
