# ๐ ูุฎุทุท ุณูุฑ ุนูููุฉ ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูููู ูุดุฑุญ ุนูููุฉ ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ (Forgot Password) ูู ุงูุชุทุจูู. ุชู ุชุญููู ุงููุธุงู ูู ูุธุงู OTP ุงูุขูู ุฅูู ูุธุงู ุทูุจุงุช ูุฏููุฉ ุชุชู ุฅุฏุงุฑุชูุง ูู ููุญุฉ ุงูุชุญูู.

ุงูุนูููุฉ ุชุชููู ูู **ุฎุทูุชูู ุฑุฆูุณูุชูู**:
1. ุงูุนููู ููุฏู ุทูุจ ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ
2. ุงููุดุฑู ูุนุงูุฌ ุงูุทูุจ ููุฑุณู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ููุนููู ูุฏููุงู
3. ุงูุนููู ูุบูุฑ ูููุฉ ุงููุฑูุฑ ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู ุจุงููููุฉ ุงููุคูุชุฉ

---

## ๐ ุงูุญููู ุงููุทููุจุฉ

### ุงูุฎุทูุฉ 1: ุชูุฏูู ุทูุจ ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ (Request Password Reset)

1. **`phone`** - ุฑูู ุงููุงุชู
   - ููุน: `string`
   - ุงูุตูุบุฉ: ุฑูู ุฏููู (ูุซุงู: `+966501234567`)
   - ุงูุชุญูู: ูุฌุจ ุฃู ูููู ุจุตูุบุฉ ุฏูููุฉ ุตุญูุญุฉ

2. **`customerNotes`** - ููุงุญุธุงุช ุงูุนููู (ุงุฎุชูุงุฑู)
   - ููุน: `string`
   - ูุตู: ููุงุญุธุงุช ุฅุถุงููุฉ ูู ุงูุนููู ุญูู ุงูุทูุจ

---

## ๐ ูุฎุทุท ุณูุฑ ุงูุนูู (Mermaid Flowchart)

```mermaid
%%{init: {'theme':'base', 'themeVariables': {'primaryTextColor':'#ffffff', 'primaryColor':'#2196F3', 'primaryBorderColor':'#1565C0', 'lineColor':'#9E9E9E', 'secondaryColor':'#2E7D32', 'tertiaryColor':'#F44336'}}}%%
flowchart TD
    Start([ุจุฏุก ุนูููุฉ ุฅุนุงุฏุฉ ุชุนููู<br/>ูููุฉ ุงููุฑูุฑ]) --> Step1[ุงูุฎุทูุฉ 1: ุชูุฏูู ุงูุทูุจ]
    
    Step1 --> ValidatePhone[ุงูุชุญูู ูู ุตุญุฉ<br/>ุฑูู ุงููุงุชู]
    
    ValidatePhone --> FindUser[ุงูุจุญุซ ุนู ุงููุณุชุฎุฏู<br/>ุญุณุจ ุฑูู ุงููุงุชู]
    
    FindUser --> UserExists{ูู ููุฌุฏ<br/>ุงููุณุชุฎุฏู?}
    
    UserExists -->|ูุง| Error1[ุฎุทุฃ: User not found<br/>ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ]
    
    UserExists -->|ูุนู| CheckPending[ุงูุชุญูู ูู ูุฌูุฏ<br/>ุทูุจ ููุฏ ุงูุงูุชุธุงุฑ]
    
    CheckPending --> HasPending{ูู ููุฌุฏ ุทูุจ<br/>pending ูููุณุชุฎุฏู?}
    
    HasPending -->|ูุนู| Error2[ุฎุทุฃ: A password reset request<br/>is already pending]
    
    HasPending -->|ูุง| CreateRequest[ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ<br/>ูุน ุฑูู ูุฑูุฏ PWR]
    
    CreateRequest --> SaveRequest[ุญูุธ ุงูุทูุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช<br/>status: pending]
    
    SaveRequest --> Response1[ุฅุฑุฌุงุน ุงูุงุณุชุฌุงุจุฉ:<br/>requestNumber]
    
    Response1 --> AdminPanel[ุงูุทูุจ ูุธูุฑ ูู<br/>ููุญุฉ ุงูุชุญูู]
    
    AdminPanel --> AdminProcess[ุงููุดุฑู ูุนุงูุฌ ุงูุทูุจ]
    
    AdminProcess --> GeneratePassword[ุชูููุฏ ูููุฉ ูุฑูุฑ ุฌุฏูุฏุฉ<br/>12 ุญุฑู ุนุดูุงุฆู]
    
    GeneratePassword --> HashPassword[ุชุดููุฑ ูููุฉ ุงููุฑูุฑ<br/>bcrypt.hash]
    
    HashPassword --> UpdateUserPassword[ุชุญุฏูุซ ูููุฉ ูุฑูุฑ ุงููุณุชุฎุฏู<br/>user.password = hashedPassword]
    
    UpdateUserPassword --> StorePlainPassword[ุญูุธ ูููุฉ ุงููุฑูุฑ<br/>ุงููุคูุชุฉ ููุนุฑุถ]
    
    StorePlainPassword --> UpdateRequestStatus[ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ<br/>status: completed]
    
    UpdateRequestStatus --> AdminSendPassword[ุงููุดุฑู ูุฑุณู ูููุฉ ุงููุฑูุฑ<br/>ููุนููู ูุฏููุงู]
    
    AdminSendPassword --> CustomerLogin[ุงูุนููู ูุณุฌู ุงูุฏุฎูู<br/>ุจูููุฉ ุงููุฑูุฑ ุงููุคูุชุฉ]
    
    CustomerLogin --> ChangePassword[ุงูุนููู ูุบูุฑ ูููุฉ ุงููุฑูุฑ<br/>ุจุงุณุชุฎุฏุงู change-password]
    
    ChangePassword --> End([ููุงูุฉ - ุชู ุฅุนุงุฏุฉ ุชุนููู<br/>ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ])
    
    Error1 --> EndError([ุฅููุงุก - ุฎุทุฃ])
    Error2 --> EndError
```

---

## ๐ ุงูุณููุงุฑูู ุงูุชูุตููู

### 1๏ธโฃ ุงูุฎุทูุฉ 1: ุชูุฏูู ุทูุจ ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ (Request Password Reset)

#### ุฃ) ุงูุชุญูู ูู ุตุญุฉ ุฑูู ุงููุงุชู

```typescript
@IsString()
@IsNotEmpty()
@Matches(/^\+?[1-9]\d{1,14}$/)
phone: string;
```

#### ุจ) ุงูุจุญุซ ุนู ุงููุณุชุฎุฏู

```typescript
const user = await userModel.findOne({ phone });

if (!user) {
  throw BadRequestException('User not found');
}
```

**โ ุงูุฎุทุฃ 1: ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ**
- ุงูุฑุณุงูุฉ: `"User not found"`
- ุงูููุฏ: 400

#### ุฌ) ุงูุชุญูู ูู ูุฌูุฏ ุทูุจ ููุฏ ุงูุงูุชุธุงุฑ

```typescript
const existingRequest = await passwordResetRequestModel.findOne({
  customerId: user._id,
  status: 'pending',
});

if (existingRequest) {
  throw ConflictException(
    'A password reset request is already pending. Please wait for admin to process it.'
  );
}
```

**โ ุงูุฎุทุฃ 2: ุทูุจ ููุฏ ุงูุงูุชุธุงุฑ ููุฌูุฏ**
- ุงูุฑุณุงูุฉ: `"A password reset request is already pending. Please wait for admin to process it."`
- ุงูููุฏ: 409

#### ุฏ) ุฅูุดุงุก ุงูุทูุจ

```typescript
// ุชูููุฏ ุฑูู ุงูุทูุจ (PWR + ุณูุฉ + ุดูุฑ + ุฑูู ุชุณูุณูู)
const requestNumber = await generatePasswordResetRequestNumber(); // ูุซุงู: "PWR24120001"

// ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ
const request = await passwordResetRequestModel.create({
  requestNumber,
  customerId: user._id,
  phone: user.phone,
  status: 'pending',
  customerNotes: customerNotes || undefined,
});
```

#### ูู) ุงูุงุณุชุฌุงุจุฉ

```json
{
  "success": true,
  "data": {
    "requestNumber": "PWR24120001",
    "status": "pending"
  },
  "message": "Password reset request submitted successfully. An admin will contact you soon.",
  "messageAr": "ุชู ุชูุฏูู ุทูุจ ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ. ุณูุชู ุงูุชูุงุตู ูุนู ูุฑูุจุงู."
}
```

---

### 2๏ธโฃ ุงูุฎุทูุฉ 2: ูุนุงูุฌุฉ ุงูุทูุจ ูู ููุญุฉ ุงูุชุญูู (Admin Process Request)

#### ุฃ) ุงููุดุฑู ูุนุฑุถ ุงูุทูุจุงุช ูู ููุญุฉ ุงูุชุญูู

- **Endpoint (Admin)**: `GET /auth/admin/password-reset-requests`
- **ููุชุฑุฉ**: ุญุณุจ ุงูุญุงูุฉ (`pending`, `completed`, `rejected`)
- **ุงูุตูุงุญูุงุช**: ูุฌุจ ุฃู ูููู ุงููุดุฑู ูุณุฌูุงู ุฏุฎูู

#### ุจ) ุงููุดุฑู ูุนุงูุฌ ุงูุทูุจ

**Endpoint (Admin)**: `POST /auth/admin/password-reset-requests/:id/process`

**Request Body (ุงุฎุชูุงุฑู)**:
```json
{
  "adminNotes": "ุชู ูุนุงูุฌุฉ ุงูุทูุจ ูุฅุฑุณุงู ูููุฉ ุงููุฑูุฑ ููุนููู ุนุจุฑ ูุงุชุณุงุจ"
}
```

**Workflow ูู Backend**:

```typescript
// 1. ุงูุจุญุซ ุนู ุงูุทูุจ
const request = await passwordResetRequestModel.findById(requestId);

if (!request || request.status !== 'pending') {
  throw BadRequestException('Request not found or already processed');
}

// 2. ุชูููุฏ ูููุฉ ูุฑูุฑ ูุคูุชุฉ (12 ุญุฑู)
const temporaryPassword = generateTemporaryPassword(); // ูุซุงู: "Xy9@mP2kL$w"

// 3. ุชุดููุฑ ูููุฉ ุงููุฑูุฑ
const hashedPassword = await bcrypt.hash(temporaryPassword, 12);

// 4. ุชุญุฏูุซ ูููุฉ ูุฑูุฑ ุงููุณุชุฎุฏู
user.password = hashedPassword;
await user.save();

// 5. ุชุญุฏูุซ ุงูุทูุจ
request.status = 'completed';
request.temporaryPassword = hashedPassword;
request.temporaryPasswordPlain = temporaryPassword; // ูุญูุธ ูุคูุช ููุนุฑุถ
request.processedBy = adminId;
request.processedAt = new Date();
request.adminNotes = adminNotes || undefined;
await request.save();
```

#### ุฌ) ุงูุงุณุชุฌุงุจุฉ ูููุดุฑู

```json
{
  "success": true,
  "data": {
    "request": {
      "_id": "...",
      "requestNumber": "PWR24120001",
      "status": "completed",
      "phone": "+966501234567",
      ...
    },
    "temporaryPassword": "Xy9@mP2kL$w"
  },
  "message": "Password reset request processed successfully. Please send the temporary password to the customer.",
  "messageAr": "ุชู ูุนุงูุฌุฉ ุทูุจ ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ. ูุฑุฌู ุฅุฑุณุงู ูููุฉ ุงููุฑูุฑ ุงููุคูุชุฉ ููุนููู."
}
```

**โ๏ธ ููุงุญุธุฉ ูููุฉ**: 
- ูููุฉ ุงููุฑูุฑ ุงููุคูุชุฉ `temporaryPasswordPlain` ุชูุนุฑุถ ูููุดุฑู ูู ููุญุฉ ุงูุชุญูู ูููุณุฎ ูุงูุฅุฑุณุงู ูุฏููุงู
- ูุฌุจ ุนูู ุงููุดุฑู ุฅุฑุณุงู ูููุฉ ุงููุฑูุฑ ููุนููู ุนุจุฑ ูุงุชุณุงุจ/ุฅูููู/ูุงุชู
- ูููุฉ ุงููุฑูุฑ ุงููุคูุชุฉ ูุฌุจ ุฃู ุชูุญุฐู ุจุนุฏ ูุชุฑุฉ ูู ุงูุฒูู (ุฃู ุจุนุฏ ุงุณุชุฎุฏุงููุง)

#### ุฏ) ุฑูุถ ุงูุทูุจ (ุงุฎุชูุงุฑู)

**Endpoint (Admin)**: `POST /auth/admin/password-reset-requests/:id/reject`

**Request Body**:
```json
{
  "rejectionReason": "ูู ูุชู ุงูุชุญูู ูู ูููุฉ ุงูุนููู",
  "adminNotes": "ูุฑุฌู ุงูุชูุงุตู ูุน ุงูุฏุนู ุงูููู ูุจุงุดุฑุฉ"
}
```

---

### 3๏ธโฃ ุงูุฎุทูุฉ 3: ุงูุนููู ูุบูุฑ ูููุฉ ุงููุฑูุฑ (Change Password)

ุจุนุฏ ุฃู ูุณุชูู ุงูุนููู ูููุฉ ุงููุฑูุฑ ุงููุคูุชุฉ ูู ุงููุดุฑู:

#### ุฃ) ุชุณุฌูู ุงูุฏุฎูู ุจุงููููุฉ ุงููุคูุชุฉ

- **Endpoint**: `POST /auth/login`
- **Phone**: ุฑูู ุงููุงุชู
- **Password**: ูููุฉ ุงููุฑูุฑ ุงููุคูุชุฉ ุงููุฑุณูุฉ ูู ุงููุดุฑู

#### ุจ) ุชุบููุฑ ูููุฉ ุงููุฑูุฑ

- **Endpoint**: `PATCH /auth/change-password`
- **Headers**: `Authorization: Bearer <accessToken>`

**Request Body**:
```json
{
  "oldPassword": "Xy9@mP2kL$w",
  "newPassword": "NewStrongP@ss123"
}
```

**Validation ููููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ**:
- ุงูุญุฏ ุงูุฃุฏูู: 8 ุฃุญุฑู
- ุงูุญุฏ ุงูุฃูุตู: 50 ุญุฑู
- ูุฌุจ ุฃู ุชุญุชูู ุนูู:
  - ุญุฑู ูุจูุฑ ูุงุญุฏ ุนูู ุงูุฃูู (A-Z)
  - ุญุฑู ุตุบูุฑ ูุงุญุฏ ุนูู ุงูุฃูู (a-z)
  - ุฑูู ูุงุญุฏ ุนูู ุงูุฃูู (0-9)
  - ุฑูุฒ ุฎุงุต ูุงุญุฏ ุนูู ุงูุฃูู (@$!%*?&)

---

## ๐ ููุฎุต ุงูุฃุฎุทุงุก ูุงูุญุงูุงุช ุงููุฑููุถุฉ

### ุงูุฎุทูุฉ 1: ุชูุฏูู ุทูุจ ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ

| # | ุงูุญุงูุฉ | ุฑุณุงูุฉ ุงูุฎุทุฃ | ุงูููุฏ | ูุตู |
|---|--------|-------------|-------|------|
| 1 | ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ | `User not found` | 400 | ูู ูุชู ุงูุนุซูุฑ ุนูู ูุณุชุฎุฏู ุจูุฐุง ุฑูู ุงููุงุชู |
| 2 | ุทูุจ ููุฏ ุงูุงูุชุธุงุฑ ููุฌูุฏ | `A password reset request is already pending. Please wait for admin to process it.` | 409 | ููุฌุฏ ุจุงููุนู ุทูุจ ููุฏ ุงูุงูุชุธุงุฑ ููุฐุง ุงููุณุชุฎุฏู |

### ุงูุฎุทูุฉ 2: ูุนุงูุฌุฉ ุงูุทูุจ (Admin)

| # | ุงูุญุงูุฉ | ุฑุณุงูุฉ ุงูุฎุทุฃ | ุงูููุฏ | ูุตู |
|---|--------|-------------|-------|------|
| 3 | ุงูุทูุจ ุบูุฑ ููุฌูุฏ | `Password reset request not found` | 400 | ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุทูุจ |
| 4 | ุงูุทูุจ ุชู ูุนุงูุฌุชู ูุณุจูุงู | `Request is already [status]. Cannot process it again.` | 400 | ุงูุทูุจ ุชู ูุนุงูุฌุชู ุฃู ุฑูุถู ูุณุจูุงู |

### ุงูุฎุทูุฉ 3: ุชุบููุฑ ูููุฉ ุงููุฑูุฑ

| # | ุงูุญุงูุฉ | ุฑุณุงูุฉ ุงูุฎุทุฃ | ุงูููุฏ | ูุตู |
|---|--------|-------------|-------|------|
| 5 | ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ ุบูุฑ ุตุญูุญุฉ | `Current password is incorrect` | 400 | ูููุฉ ุงููุฑูุฑ ุงููุคูุชุฉ ุบูุฑ ุตุญูุญุฉ |
| 6 | ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ููุงุซูุฉ ูููุฏููุฉ | `New password must be different from current password` | 400 | ูุฌุจ ุฃู ุชููู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ูุฎุชููุฉ |
| 7 | ูููุฉ ุงููุฑูุฑ ูุง ุชุญูู ุงูุดุฑูุท | `Password validation failed` | 400 | ูููุฉ ุงููุฑูุฑ ูุง ุชุญูู ุงูุดุฑูุท ุงููุทููุจุฉ |

---

## ๐ ููุงุนุฏ ุงูุฃูุงู

### ุทูุจุงุช ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ

- **ุงูุญุงูุงุช ุงููุชุงุญุฉ**: `pending`, `completed`, `rejected`
- **ููุน ุงูุทูุจุงุช ุงูููุฑุฑุฉ**: ูุง ูููู ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ ุฅุฐุง ูุงู ููุงู ุทูุจ `pending` ููุฌูุฏ
- **ุฃูุงู ูููุฉ ุงููุฑูุฑ ุงููุคูุชุฉ**: 
  - ูุชู ุชุดููุฑ ูููุฉ ุงููุฑูุฑ ุงููุคูุชุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  - ูููุฉ ุงููุฑูุฑ ุงููุคูุชุฉ (`temporaryPasswordPlain`) ุชูุญูุธ ูุคูุชุงู ููุนุฑุถ ููุท
  - ูุฌุจ ุนูู ุงููุดุฑู ุญุฐู/ุนุฏู ุญูุธ ูููุฉ ุงููุฑูุฑ ุจุนุฏ ุฅุฑุณุงููุง ููุนููู

### ุชูููุฏ ูููุฉ ุงููุฑูุฑ ุงููุคูุชุฉ

- **ุงูุทูู**: 12 ุญุฑู
- **ุงููุญุชูู**: ูุฒูุฌ ุนุดูุงุฆู ูู:
  - ุฃุญุฑู ูุจูุฑุฉ (A-Z)
  - ุฃุญุฑู ุตุบูุฑุฉ (a-z)
  - ุฃุฑูุงู (0-9)
  - ุฑููุฒ ุฎุงุตุฉ (@$!%*?&)
- **ุงูุถูุงู**: ูุญุชูู ุนูู ุญุฑู ูุจูุฑุ ุญุฑู ุตุบูุฑุ ุฑููุ ูุฑูุฒ ุฎุงุต ุนูู ุงูุฃูู

### ุดุฑูุท ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ

- **ุงูุญุฏ ุงูุฃุฏูู**: 8 ุฃุญุฑู
- **ุงูุญุฏ ุงูุฃูุตู**: 50 ุญุฑู
- **ุงูุดุฑูุท**:
  - ุญุฑู ูุจูุฑ ูุงุญุฏ ุนูู ุงูุฃูู (A-Z)
  - ุญุฑู ุตุบูุฑ ูุงุญุฏ ุนูู ุงูุฃูู (a-z)
  - ุฑูู ูุงุญุฏ ุนูู ุงูุฃูู (0-9)
  - ุฑูุฒ ุฎุงุต ูุงุญุฏ ุนูู ุงูุฃูู (@$!%*?&)

---

## ๐ฏ ุงููุฑู ุจูู ุงููุธุงู ุงููุฏูู ูุงูุฌุฏูุฏ

### ุงููุธุงู ุงููุฏูู (OTP)
- 3 ุฎุทูุงุช: ุฅุฑุณุงู OTP โ ุงูุชุญูู ูู OTP โ ุชุนููู ูููุฉ ูุฑูุฑ ุฌุฏูุฏุฉ
- ุชููุงุฆู ุจุงููุงูู
- ูุง ูุชุทูุจ ุชุฏุฎู ุงููุดุฑู

### ุงููุธุงู ุงูุฌุฏูุฏ (Manual Request)
- ุฎุทูุชุงู: ุชูุฏูู ุทูุจ โ ูุนุงูุฌุฉ ุงููุดุฑู + ุชุบููุฑ ูููุฉ ุงููุฑูุฑ
- ูุชุทูุจ ุชุฏุฎู ุงููุดุฑู
- ูููุฑ ุชุญูู ุฃูุถู ูุฃูุงู ุฃุนูู
- ูุณูุญ ุจูุฑุงุฌุนุฉ ุงูุทูุจุงุช ูุจู ุงููุนุงูุฌุฉ

---

## ๐ ูุฑุงุฌุน

- **API Endpoints (Customer)**:
  - `POST /auth/request-password-reset` - ุชูุฏูู ุทูุจ ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ
  - `PATCH /auth/change-password` - ุชุบููุฑ ูููุฉ ุงููุฑูุฑ (ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู)

- **API Endpoints (Admin)**:
  - `GET /auth/admin/password-reset-requests` - ูุงุฆูุฉ ุทูุจุงุช ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ
  - `GET /auth/admin/password-reset-requests/:id` - ุชูุงุตูู ุทูุจ ูุญุฏุฏ
  - `POST /auth/admin/password-reset-requests/:id/process` - ูุนุงูุฌุฉ ุงูุทูุจ
  - `POST /auth/admin/password-reset-requests/:id/reject` - ุฑูุถ ุงูุทูุจ

- **ุงูุชูุซูู ุงููุงูู**: `docs/flutter-integration/auth.md`
